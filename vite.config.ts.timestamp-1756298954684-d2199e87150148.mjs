// vite.config.ts
import { defineConfig } from "file:///C:/Dev/super-benji/node_modules/vite/dist/node/index.js";
import path from "path";
import fs from "fs/promises";
import typescriptPlugin from "file:///C:/Dev/super-benji/node_modules/@rollup/plugin-typescript/dist/index.js";
import { Packer } from "file:///C:/Dev/super-benji/node_modules/roadroller/index.mjs";
import CleanCSS from "file:///C:/Dev/super-benji/node_modules/clean-css/index.js";
import { statSync } from "fs";
import { execFileSync } from "child_process";
import ect from "file:///C:/Dev/super-benji/node_modules/ect-bin/index.js";
import htmlMinify from "file:///C:/Dev/super-benji/node_modules/html-minifier/src/htmlminifier.js";
import tmp from "file:///C:/Dev/super-benji/node_modules/tmp/lib/tmp.js";
import closure from "file:///C:/Dev/super-benji/node_modules/google-closure-compiler/index.js";
var __vite_injected_original_dirname = "C:\\Dev\\super-benji";
var { compiler: ClosureCompiler } = closure;
var vite_config_default = defineConfig(({ command, mode }) => {
  const config = {
    server: {
      port: 3e3
    },
    resolve: {
      alias: {
        "@": path.resolve(__vite_injected_original_dirname, "./src")
      }
    },
    plugins: void 0
  };
  if (command === "build") {
    config.esbuild = false;
    config.base = "";
    config.build = {
      minify: false,
      target: "es2020",
      modulePreload: { polyfill: false },
      assetsInlineLimit: 800,
      assetsDir: "",
      rollupOptions: {
        output: {
          inlineDynamicImports: true,
          manualChunks: void 0,
          assetFileNames: `[name].[ext]`
        }
      }
    };
    config.plugins = [
      typescriptPlugin(),
      closurePlugin(),
      roadrollerPlugin(),
      ectPlugin()
    ];
  }
  return config;
});
function closurePlugin() {
  return {
    name: "closure-compiler",
    // @ts-ignore
    renderChunk: applyClosure,
    enforce: "post"
  };
}
async function applyClosure(js, chunk) {
  const tmpobj = tmp.fileSync();
  js = js.replaceAll("const ", "let ");
  await fs.writeFile(tmpobj.name, js);
  const closureCompiler = new ClosureCompiler({
    js: tmpobj.name,
    externs: "externs.js",
    compilation_level: "ADVANCED",
    language_in: "ECMASCRIPT_2020",
    language_out: "ECMASCRIPT_2020"
  });
  return new Promise((resolve, reject) => {
    closureCompiler.run((_exitCode, stdOut, stdErr) => {
      if (stdOut !== "") {
        resolve({ code: stdOut });
      } else if (stdErr !== "") {
        reject(stdErr);
        return;
      }
      console.warn(stdErr);
    });
  });
}
function roadrollerPlugin() {
  return {
    name: "vite:roadroller",
    transformIndexHtml: {
      enforce: "post",
      transform: async (html, ctx) => {
        if (!ctx || !ctx.bundle) {
          return html;
        }
        const options = {
          includeAutoGeneratedTags: true,
          removeAttributeQuotes: true,
          removeComments: true,
          removeRedundantAttributes: true,
          removeScriptTypeAttributes: true,
          removeStyleLinkTypeAttributes: true,
          sortClassName: true,
          useShortDoctype: true,
          collapseWhitespace: true,
          collapseInlineTagWhitespace: true,
          removeEmptyAttributes: true,
          removeOptionalTags: true,
          sortAttributes: true,
          minifyCSS: true
        };
        const bundleOutputs = Object.values(ctx.bundle);
        const javascript = bundleOutputs.find(
          (output) => output.fileName.endsWith(".js")
        );
        const css = bundleOutputs.find(
          (output) => output.fileName.endsWith(".css")
        );
        const otherBundleOutputs = bundleOutputs.filter(
          (output) => output !== javascript
        );
        if (otherBundleOutputs.length > 0) {
          otherBundleOutputs.forEach(
            (output) => console.warn(`WARN Asset not inlined: ${output.fileName}`)
          );
        }
        const cssInHtml = css ? embedCss(html, css) : html;
        const minifiedHtml = await htmlMinify.minify(cssInHtml, options);
        return embedJs(minifiedHtml, javascript);
      }
    }
  };
}
async function embedJs(html, chunk) {
  const scriptTagRemoved = html.replace(
    new RegExp(`<script[^>]*?src=[./]*${chunk.fileName}[^>]*?></script>`),
    ""
  );
  const htmlInJs = `document.write('${scriptTagRemoved}');` + chunk.code.trim();
  const inputs = [
    {
      data: htmlInJs,
      type: "js",
      action: "eval"
    }
  ];
  let options;
  if (process.env.USE_RR_CONFIG) {
    try {
      options = JSON.parse(
        await fs.readFile(`${__vite_injected_original_dirname}/roadroller-config.json`, "utf-8")
      );
    } catch (error) {
      throw new Error(
        "Roadroller config not found. Generate one or use the regular build option"
      );
    }
  } else {
    options = { allowFreeVars: true };
  }
  const packer = new Packer(inputs, options);
  await Promise.all([
    fs.writeFile(`${path.join(__vite_injected_original_dirname, "dist")}/output.js`, htmlInJs),
    packer.optimize(process.env.LEVEL_2_BUILD ? 2 : 0)
    // Regular builds use level 2, but rr config builds use the supplied params
  ]);
  const { firstLine, secondLine } = packer.makeDecoder();
  return `<script>
${firstLine}
${secondLine}
</script>`;
}
function embedCss(html, asset) {
  const reCSS = new RegExp(
    `<link rel="stylesheet"[^>]*?href="[./]*${asset.fileName}"[^>]*?>`
  );
  const code = `<style>${new CleanCSS({ level: 2 }).minify(asset.source).styles}</style>`;
  return html.replace(reCSS, code);
}
function ectPlugin() {
  return {
    name: "vite:ect",
    writeBundle: async () => {
      try {
        const files = await fs.readdir("dist/");
        const assetFiles = files.filter((file) => {
          return !file.includes(".js") && !file.includes(".css") && !file.includes(".html") && !file.includes(".zip") && file !== "assets";
        }).map((file) => "dist/" + file);
        const args = [
          "-strip",
          "-zip",
          "-10009",
          "dist/index.html",
          ...assetFiles
        ];
        const result = execFileSync(ect, args);
        console.log("ECT result", result.toString().trim());
        const stats = statSync("dist/index.zip");
        console.log("ZIP size", stats.size);
      } catch (err) {
        console.log("ECT error", err);
      }
    }
  };
}
export {
  vite_config_default as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsidml0ZS5jb25maWcudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImNvbnN0IF9fdml0ZV9pbmplY3RlZF9vcmlnaW5hbF9kaXJuYW1lID0gXCJDOlxcXFxEZXZcXFxcc3VwZXItYmVuamlcIjtjb25zdCBfX3ZpdGVfaW5qZWN0ZWRfb3JpZ2luYWxfZmlsZW5hbWUgPSBcIkM6XFxcXERldlxcXFxzdXBlci1iZW5qaVxcXFx2aXRlLmNvbmZpZy50c1wiO2NvbnN0IF9fdml0ZV9pbmplY3RlZF9vcmlnaW5hbF9pbXBvcnRfbWV0YV91cmwgPSBcImZpbGU6Ly8vQzovRGV2L3N1cGVyLWJlbmppL3ZpdGUuY29uZmlnLnRzXCI7aW1wb3J0IHsgZGVmaW5lQ29uZmlnLCBJbmRleEh0bWxUcmFuc2Zvcm1Db250ZXh0LCBQbHVnaW4gfSBmcm9tIFwidml0ZVwiO1xyXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgZnMgZnJvbSBcImZzL3Byb21pc2VzXCI7XHJcbmltcG9ydCB0eXBlc2NyaXB0UGx1Z2luIGZyb20gXCJAcm9sbHVwL3BsdWdpbi10eXBlc2NyaXB0XCI7XHJcbmltcG9ydCB7IE91dHB1dEFzc2V0LCBPdXRwdXRDaHVuayB9IGZyb20gXCJyb2xsdXBcIjtcclxuaW1wb3J0IHsgSW5wdXQsIElucHV0QWN0aW9uLCBJbnB1dFR5cGUsIFBhY2tlciB9IGZyb20gXCJyb2Fkcm9sbGVyXCI7XHJcbmltcG9ydCBDbGVhbkNTUyBmcm9tIFwiY2xlYW4tY3NzXCI7XHJcbmltcG9ydCB7IHN0YXRTeW5jIH0gZnJvbSBcImZzXCI7XHJcbmltcG9ydCB7IGV4ZWNGaWxlU3luYyB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XHJcbmltcG9ydCBlY3QgZnJvbSBcImVjdC1iaW5cIjtcclxuXHJcbmltcG9ydCBodG1sTWluaWZ5IGZyb20gXCJodG1sLW1pbmlmaWVyXCI7XHJcbmltcG9ydCB0bXAgZnJvbSBcInRtcFwiO1xyXG5pbXBvcnQgY2xvc3VyZSBmcm9tIFwiZ29vZ2xlLWNsb3N1cmUtY29tcGlsZXJcIjtcclxuY29uc3QgeyBjb21waWxlcjogQ2xvc3VyZUNvbXBpbGVyIH0gPSBjbG9zdXJlO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZGVmaW5lQ29uZmlnKCh7IGNvbW1hbmQsIG1vZGUgfSkgPT4ge1xyXG4gIGNvbnN0IGNvbmZpZyA9IHtcclxuICAgIHNlcnZlcjoge1xyXG4gICAgICBwb3J0OiAzMDAwLFxyXG4gICAgfSxcclxuICAgIHJlc29sdmU6IHtcclxuICAgICAgYWxpYXM6IHtcclxuICAgICAgICBcIkBcIjogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuL3NyY1wiKSxcclxuICAgICAgfSxcclxuICAgIH0sXHJcbiAgICBwbHVnaW5zOiB1bmRlZmluZWQsXHJcbiAgfTtcclxuXHJcbiAgaWYgKGNvbW1hbmQgPT09IFwiYnVpbGRcIikge1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgY29uZmlnLmVzYnVpbGQgPSBmYWxzZTtcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIGNvbmZpZy5iYXNlID0gXCJcIjtcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIGNvbmZpZy5idWlsZCA9IHtcclxuICAgICAgbWluaWZ5OiBmYWxzZSxcclxuICAgICAgdGFyZ2V0OiBcImVzMjAyMFwiLFxyXG4gICAgICBtb2R1bGVQcmVsb2FkOiB7IHBvbHlmaWxsOiBmYWxzZSB9LFxyXG4gICAgICBhc3NldHNJbmxpbmVMaW1pdDogODAwLFxyXG4gICAgICBhc3NldHNEaXI6IFwiXCIsXHJcbiAgICAgIHJvbGx1cE9wdGlvbnM6IHtcclxuICAgICAgICBvdXRwdXQ6IHtcclxuICAgICAgICAgIGlubGluZUR5bmFtaWNJbXBvcnRzOiB0cnVlLFxyXG4gICAgICAgICAgbWFudWFsQ2h1bmtzOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICBhc3NldEZpbGVOYW1lczogYFtuYW1lXS5bZXh0XWAsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgIH07XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICBjb25maWcucGx1Z2lucyA9IFtcclxuICAgICAgdHlwZXNjcmlwdFBsdWdpbigpLFxyXG4gICAgICBjbG9zdXJlUGx1Z2luKCksXHJcbiAgICAgIHJvYWRyb2xsZXJQbHVnaW4oKSxcclxuICAgICAgZWN0UGx1Z2luKCksXHJcbiAgICBdO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGNvbmZpZztcclxufSk7XHJcblxyXG5mdW5jdGlvbiBjbG9zdXJlUGx1Z2luKCk6IFBsdWdpbiB7XHJcbiAgcmV0dXJuIHtcclxuICAgIG5hbWU6IFwiY2xvc3VyZS1jb21waWxlclwiLFxyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgcmVuZGVyQ2h1bms6IGFwcGx5Q2xvc3VyZSxcclxuICAgIGVuZm9yY2U6IFwicG9zdFwiLFxyXG4gIH07XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGFwcGx5Q2xvc3VyZShqczogc3RyaW5nLCBjaHVuazogYW55KSB7XHJcbiAgY29uc3QgdG1wb2JqID0gdG1wLmZpbGVTeW5jKCk7XHJcbiAgLy8gcmVwbGFjZSBhbGwgY29uc3RzIHdpdGggbGV0cyB0byBzYXZlIGFib3V0IDUwLTcwIGJ5dGVzXHJcbiAgLy8gdHMtaWdub3JlXHJcbiAganMgPSBqcy5yZXBsYWNlQWxsKFwiY29uc3QgXCIsIFwibGV0IFwiKTtcclxuXHJcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRtcG9iai5uYW1lLCBqcyk7XHJcbiAgY29uc3QgY2xvc3VyZUNvbXBpbGVyID0gbmV3IENsb3N1cmVDb21waWxlcih7XHJcbiAgICBqczogdG1wb2JqLm5hbWUsXHJcbiAgICBleHRlcm5zOiBcImV4dGVybnMuanNcIixcclxuICAgIGNvbXBpbGF0aW9uX2xldmVsOiBcIkFEVkFOQ0VEXCIsXHJcbiAgICBsYW5ndWFnZV9pbjogXCJFQ01BU0NSSVBUXzIwMjBcIixcclxuICAgIGxhbmd1YWdlX291dDogXCJFQ01BU0NSSVBUXzIwMjBcIixcclxuICB9KTtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgY2xvc3VyZUNvbXBpbGVyLnJ1bigoX2V4aXRDb2RlOiBzdHJpbmcsIHN0ZE91dDogc3RyaW5nLCBzdGRFcnI6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAoc3RkT3V0ICE9PSBcIlwiKSB7XHJcbiAgICAgICAgcmVzb2x2ZSh7IGNvZGU6IHN0ZE91dCB9KTtcclxuICAgICAgfSBlbHNlIGlmIChzdGRFcnIgIT09IFwiXCIpIHtcclxuICAgICAgICAvLyBvbmx5IHJlamVjdCBpZiBzdGRvdXQgaXNuJ3QgZ2VuZXJhdGVkXHJcbiAgICAgICAgcmVqZWN0KHN0ZEVycik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLndhcm4oc3RkRXJyKTsgLy8gSWYgd2UgbWFrZSBpdCBoZXJlLCB0aGVyZSB3ZXJlIHdhcm5pbmdzIGJ1dCBubyBlcnJvcnNcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiByb2Fkcm9sbGVyUGx1Z2luKCk6IFBsdWdpbiB7XHJcbiAgcmV0dXJuIHtcclxuICAgIG5hbWU6IFwidml0ZTpyb2Fkcm9sbGVyXCIsXHJcbiAgICB0cmFuc2Zvcm1JbmRleEh0bWw6IHtcclxuICAgICAgZW5mb3JjZTogXCJwb3N0XCIsXHJcbiAgICAgIHRyYW5zZm9ybTogYXN5bmMgKFxyXG4gICAgICAgIGh0bWw6IHN0cmluZyxcclxuICAgICAgICBjdHg/OiBJbmRleEh0bWxUcmFuc2Zvcm1Db250ZXh0XHJcbiAgICAgICk6IFByb21pc2U8c3RyaW5nPiA9PiB7XHJcbiAgICAgICAgLy8gT25seSB1c2UgdGhpcyBwbHVnaW4gZHVyaW5nIGJ1aWxkXHJcbiAgICAgICAgaWYgKCFjdHggfHwgIWN0eC5idW5kbGUpIHtcclxuICAgICAgICAgIHJldHVybiBodG1sO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgIGluY2x1ZGVBdXRvR2VuZXJhdGVkVGFnczogdHJ1ZSxcclxuICAgICAgICAgIHJlbW92ZUF0dHJpYnV0ZVF1b3RlczogdHJ1ZSxcclxuICAgICAgICAgIHJlbW92ZUNvbW1lbnRzOiB0cnVlLFxyXG4gICAgICAgICAgcmVtb3ZlUmVkdW5kYW50QXR0cmlidXRlczogdHJ1ZSxcclxuICAgICAgICAgIHJlbW92ZVNjcmlwdFR5cGVBdHRyaWJ1dGVzOiB0cnVlLFxyXG4gICAgICAgICAgcmVtb3ZlU3R5bGVMaW5rVHlwZUF0dHJpYnV0ZXM6IHRydWUsXHJcbiAgICAgICAgICBzb3J0Q2xhc3NOYW1lOiB0cnVlLFxyXG4gICAgICAgICAgdXNlU2hvcnREb2N0eXBlOiB0cnVlLFxyXG4gICAgICAgICAgY29sbGFwc2VXaGl0ZXNwYWNlOiB0cnVlLFxyXG4gICAgICAgICAgY29sbGFwc2VJbmxpbmVUYWdXaGl0ZXNwYWNlOiB0cnVlLFxyXG4gICAgICAgICAgcmVtb3ZlRW1wdHlBdHRyaWJ1dGVzOiB0cnVlLFxyXG4gICAgICAgICAgcmVtb3ZlT3B0aW9uYWxUYWdzOiB0cnVlLFxyXG4gICAgICAgICAgc29ydEF0dHJpYnV0ZXM6IHRydWUsXHJcbiAgICAgICAgICBtaW5pZnlDU1M6IHRydWUsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgYnVuZGxlT3V0cHV0cyA9IE9iamVjdC52YWx1ZXMoY3R4LmJ1bmRsZSk7XHJcbiAgICAgICAgY29uc3QgamF2YXNjcmlwdCA9IGJ1bmRsZU91dHB1dHMuZmluZCgob3V0cHV0KSA9PlxyXG4gICAgICAgICAgb3V0cHV0LmZpbGVOYW1lLmVuZHNXaXRoKFwiLmpzXCIpXHJcbiAgICAgICAgKSBhcyBPdXRwdXRDaHVuaztcclxuICAgICAgICBjb25zdCBjc3MgPSBidW5kbGVPdXRwdXRzLmZpbmQoKG91dHB1dCkgPT5cclxuICAgICAgICAgIG91dHB1dC5maWxlTmFtZS5lbmRzV2l0aChcIi5jc3NcIilcclxuICAgICAgICApIGFzIE91dHB1dEFzc2V0O1xyXG4gICAgICAgIGNvbnN0IG90aGVyQnVuZGxlT3V0cHV0cyA9IGJ1bmRsZU91dHB1dHMuZmlsdGVyKFxyXG4gICAgICAgICAgKG91dHB1dCkgPT4gb3V0cHV0ICE9PSBqYXZhc2NyaXB0XHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAob3RoZXJCdW5kbGVPdXRwdXRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIG90aGVyQnVuZGxlT3V0cHV0cy5mb3JFYWNoKChvdXRwdXQpID0+XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgV0FSTiBBc3NldCBub3QgaW5saW5lZDogJHtvdXRwdXQuZmlsZU5hbWV9YClcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjc3NJbkh0bWwgPSBjc3MgPyBlbWJlZENzcyhodG1sLCBjc3MpIDogaHRtbDtcclxuICAgICAgICBjb25zdCBtaW5pZmllZEh0bWwgPSBhd2FpdCBodG1sTWluaWZ5Lm1pbmlmeShjc3NJbkh0bWwsIG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiBlbWJlZEpzKG1pbmlmaWVkSHRtbCwgamF2YXNjcmlwdCk7XHJcbiAgICAgIH0sXHJcbiAgICB9LFxyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUcmFuc2Zvcm1zIHRoZSBnaXZlbiBKYXZhU2NyaXB0IGNvZGUgaW50byBhIHBhY2tlZCB2ZXJzaW9uLlxyXG4gKiBAcGFyYW0gaHRtbCBUaGUgb3JpZ2luYWwgSFRNTC5cclxuICogQHBhcmFtIGNodW5rIFRoZSBKYXZhU2NyaXB0IG91dHB1dCBjaHVuayBmcm9tIFJvbGx1cC9WaXRlLlxyXG4gKiBAcmV0dXJucyBUaGUgdHJhbnNmb3JtZWQgSFRNTCB3aXRoIHRoZSBKYXZhU2NyaXB0IGVtYmVkZGVkLlxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZW1iZWRKcyhodG1sOiBzdHJpbmcsIGNodW5rOiBPdXRwdXRDaHVuayk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgY29uc3Qgc2NyaXB0VGFnUmVtb3ZlZCA9IGh0bWwucmVwbGFjZShcclxuICAgIG5ldyBSZWdFeHAoYDxzY3JpcHRbXj5dKj9zcmM9W1xcLi9dKiR7Y2h1bmsuZmlsZU5hbWV9W14+XSo/Pjwvc2NyaXB0PmApLFxyXG4gICAgXCJcIlxyXG4gICk7XHJcbiAgY29uc3QgaHRtbEluSnMgPSBgZG9jdW1lbnQud3JpdGUoJyR7c2NyaXB0VGFnUmVtb3ZlZH0nKTtgICsgY2h1bmsuY29kZS50cmltKCk7XHJcblxyXG4gIGNvbnN0IGlucHV0czogSW5wdXRbXSA9IFtcclxuICAgIHtcclxuICAgICAgZGF0YTogaHRtbEluSnMsXHJcbiAgICAgIHR5cGU6IFwianNcIiBhcyBJbnB1dFR5cGUsXHJcbiAgICAgIGFjdGlvbjogXCJldmFsXCIgYXMgSW5wdXRBY3Rpb24sXHJcbiAgICB9LFxyXG4gIF07XHJcblxyXG4gIGxldCBvcHRpb25zO1xyXG4gIGlmIChwcm9jZXNzLmVudi5VU0VfUlJfQ09ORklHKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShcclxuICAgICAgICBhd2FpdCBmcy5yZWFkRmlsZShgJHtfX2Rpcm5hbWV9L3JvYWRyb2xsZXItY29uZmlnLmpzb25gLCBcInV0Zi04XCIpXHJcbiAgICAgICk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgXCJSb2Fkcm9sbGVyIGNvbmZpZyBub3QgZm91bmQuIEdlbmVyYXRlIG9uZSBvciB1c2UgdGhlIHJlZ3VsYXIgYnVpbGQgb3B0aW9uXCJcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgb3B0aW9ucyA9IHsgYWxsb3dGcmVlVmFyczogdHJ1ZSB9O1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcGFja2VyID0gbmV3IFBhY2tlcihpbnB1dHMsIG9wdGlvbnMpO1xyXG4gIGF3YWl0IFByb21pc2UuYWxsKFtcclxuICAgIGZzLndyaXRlRmlsZShgJHtwYXRoLmpvaW4oX19kaXJuYW1lLCBcImRpc3RcIil9L291dHB1dC5qc2AsIGh0bWxJbkpzKSxcclxuICAgIHBhY2tlci5vcHRpbWl6ZShwcm9jZXNzLmVudi5MRVZFTF8yX0JVSUxEID8gMiA6IDApLCAvLyBSZWd1bGFyIGJ1aWxkcyB1c2UgbGV2ZWwgMiwgYnV0IHJyIGNvbmZpZyBidWlsZHMgdXNlIHRoZSBzdXBwbGllZCBwYXJhbXNcclxuICBdKTtcclxuICBjb25zdCB7IGZpcnN0TGluZSwgc2Vjb25kTGluZSB9ID0gcGFja2VyLm1ha2VEZWNvZGVyKCk7XHJcbiAgcmV0dXJuIGA8c2NyaXB0PlxcbiR7Zmlyc3RMaW5lfVxcbiR7c2Vjb25kTGluZX1cXG48L3NjcmlwdD5gO1xyXG59XHJcblxyXG4vKipcclxuICogRW1iZWRzIENTUyBpbnRvIHRoZSBIVE1MLlxyXG4gKiBAcGFyYW0gaHRtbCBUaGUgb3JpZ2luYWwgSFRNTC5cclxuICogQHBhcmFtIGFzc2V0IFRoZSBDU1MgYXNzZXQuXHJcbiAqIEByZXR1cm5zIFRoZSB0cmFuc2Zvcm1lZCBIVE1MIHdpdGggdGhlIENTUyBlbWJlZGRlZC5cclxuICovXHJcbmZ1bmN0aW9uIGVtYmVkQ3NzKGh0bWw6IHN0cmluZywgYXNzZXQ6IE91dHB1dEFzc2V0KTogc3RyaW5nIHtcclxuICBjb25zdCByZUNTUyA9IG5ldyBSZWdFeHAoXHJcbiAgICBgPGxpbmsgcmVsPVwic3R5bGVzaGVldFwiW14+XSo/aHJlZj1cIltcXC4vXSoke2Fzc2V0LmZpbGVOYW1lfVwiW14+XSo/PmBcclxuICApO1xyXG4gIGNvbnN0IGNvZGUgPSBgPHN0eWxlPiR7XHJcbiAgICBuZXcgQ2xlYW5DU1MoeyBsZXZlbDogMiB9KS5taW5pZnkoYXNzZXQuc291cmNlIGFzIHN0cmluZykuc3R5bGVzXHJcbiAgfTwvc3R5bGU+YDtcclxuICByZXR1cm4gaHRtbC5yZXBsYWNlKHJlQ1NTLCBjb2RlKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgdGhlIEVDVCBwbHVnaW4gdGhhdCB1c2VzIEVmZmljaWVudC1Db21wcmVzc2lvbi1Ub29sIHRvIGJ1aWxkIGEgemlwIGZpbGUuXHJcbiAqIEByZXR1cm5zIFRoZSBFQ1QgcGx1Z2luLlxyXG4gKi9cclxuZnVuY3Rpb24gZWN0UGx1Z2luKCk6IFBsdWdpbiB7XHJcbiAgcmV0dXJuIHtcclxuICAgIG5hbWU6IFwidml0ZTplY3RcIixcclxuICAgIHdyaXRlQnVuZGxlOiBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBmcy5yZWFkZGlyKFwiZGlzdC9cIik7XHJcbiAgICAgICAgY29uc3QgYXNzZXRGaWxlcyA9IGZpbGVzXHJcbiAgICAgICAgICAuZmlsdGVyKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgIWZpbGUuaW5jbHVkZXMoXCIuanNcIikgJiZcclxuICAgICAgICAgICAgICAhZmlsZS5pbmNsdWRlcyhcIi5jc3NcIikgJiZcclxuICAgICAgICAgICAgICAhZmlsZS5pbmNsdWRlcyhcIi5odG1sXCIpICYmXHJcbiAgICAgICAgICAgICAgIWZpbGUuaW5jbHVkZXMoXCIuemlwXCIpICYmXHJcbiAgICAgICAgICAgICAgZmlsZSAhPT0gXCJhc3NldHNcIlxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5tYXAoKGZpbGUpID0+IFwiZGlzdC9cIiArIGZpbGUpO1xyXG4gICAgICAgIGNvbnN0IGFyZ3MgPSBbXHJcbiAgICAgICAgICBcIi1zdHJpcFwiLFxyXG4gICAgICAgICAgXCItemlwXCIsXHJcbiAgICAgICAgICBcIi0xMDAwOVwiLFxyXG4gICAgICAgICAgXCJkaXN0L2luZGV4Lmh0bWxcIixcclxuICAgICAgICAgIC4uLmFzc2V0RmlsZXMsXHJcbiAgICAgICAgXTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBleGVjRmlsZVN5bmMoZWN0LCBhcmdzKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIkVDVCByZXN1bHRcIiwgcmVzdWx0LnRvU3RyaW5nKCkudHJpbSgpKTtcclxuICAgICAgICBjb25zdCBzdGF0cyA9IHN0YXRTeW5jKFwiZGlzdC9pbmRleC56aXBcIik7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJaSVAgc2l6ZVwiLCBzdGF0cy5zaXplKTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJFQ1QgZXJyb3JcIiwgZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuICB9O1xyXG59XHJcbiJdLAogICJtYXBwaW5ncyI6ICI7QUFBOE8sU0FBUyxvQkFBdUQ7QUFDOVMsT0FBTyxVQUFVO0FBQ2pCLE9BQU8sUUFBUTtBQUNmLE9BQU8sc0JBQXNCO0FBRTdCLFNBQXdDLGNBQWM7QUFDdEQsT0FBTyxjQUFjO0FBQ3JCLFNBQVMsZ0JBQWdCO0FBQ3pCLFNBQVMsb0JBQW9CO0FBQzdCLE9BQU8sU0FBUztBQUVoQixPQUFPLGdCQUFnQjtBQUN2QixPQUFPLFNBQVM7QUFDaEIsT0FBTyxhQUFhO0FBYnBCLElBQU0sbUNBQW1DO0FBY3pDLElBQU0sRUFBRSxVQUFVLGdCQUFnQixJQUFJO0FBRXRDLElBQU8sc0JBQVEsYUFBYSxDQUFDLEVBQUUsU0FBUyxLQUFLLE1BQU07QUFDakQsUUFBTSxTQUFTO0FBQUEsSUFDYixRQUFRO0FBQUEsTUFDTixNQUFNO0FBQUEsSUFDUjtBQUFBLElBQ0EsU0FBUztBQUFBLE1BQ1AsT0FBTztBQUFBLFFBQ0wsS0FBSyxLQUFLLFFBQVEsa0NBQVcsT0FBTztBQUFBLE1BQ3RDO0FBQUEsSUFDRjtBQUFBLElBQ0EsU0FBUztBQUFBLEVBQ1g7QUFFQSxNQUFJLFlBQVksU0FBUztBQUV2QixXQUFPLFVBQVU7QUFFakIsV0FBTyxPQUFPO0FBRWQsV0FBTyxRQUFRO0FBQUEsTUFDYixRQUFRO0FBQUEsTUFDUixRQUFRO0FB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
